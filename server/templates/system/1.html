<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <script src="http://code.jquery.com/jquery-latest.js"></script>
</head>
<body>


<script src='/common/js/select_box.js'></script>
<FORM name='formAJAX' action='/common/jsp/select_qry.jsp'>
<input type='hidden' name='select_source' id='select_source' value='/master/posprint/editor010.jsp'>
<input type='hidden' name='select_idx'    id='select_idx'    size='100'>
<input type='hidden' name='select_objidx' id='select_objidx' size='100'>
<input type='hidden' name='select_name'   id='select_name'   size='100'>
<input type='hidden' name='select_value'  id='select_value'  size='100'>
<input type='hidden' name='select_option' id='select_option' size='100'>
<input type='hidden' name='select_query'  id='select_query'  size='100'>
<input type='hidden' name='select_title'  id='select_title'  size='100'>
<input type='hidden' name='select_change' id='select_change' size='100'>
<input type='hidden' name='select_etc'    id='select_etc'    size='100'>
</FORM>


<html>
<head>
<title>템플릿 에디터 페이지</title>


<script language='javascript'> if(top.MainFrm) { set_url('/master/posprint/editor010.jsp'); }</script>

<script language='javascript'>



function fnSessionCheck()
{
    if(top.SessionForm
    && top.SessionForm.user_id)
    {
        if(top.SessionForm.user_id.value != "s92694")
        {
            alert("같은 세션으로 다른 사용자로 로그인 하였습니다.\n다시 로그인 하시기 바랍니다.");
            top.close();
        }
    }
    else
    if(opener
    && opener.closed == false
    && opener.top.SessionForm
    && opener.top.SessionForm.user_id)
    {
        if(opener.top.SessionForm.user_id.value != "s92694")
        {
            alert("같은 세션으로 다른 사용자로 로그인 하였습니다.\n다시 로그인 하시기 바랍니다.");
            top.close();
            opener.top.close();
        }
    }
    else
    if(opener
    && opener.closed == false
    && opener.opener
    && opener.opener.closed == false
    && opener.opener.top.SessionForm
    && opener.opener.top.SessionForm.user_id)
    {
        if(opener.opener.top.SessionForm.user_id.value != "s92694")
        {
            alert("같은 세션으로 다른 사용자로 로그인 하였습니다.\n다시 로그인 하시기 바랍니다.");
            top.close();
            opener.top.close();
            opener.opener.top.close();
        }
    }
}
setTimeout("fnSessionCheck()",0);

if(window.name == 'MainFrm' && parent.SessionForm.pass_ch_option.value == '1')
{
    showModalDialog('/master/emp/passwd010.jsp?popup_fg=Y'
                   ,self
                   ,'dialogWidth:400px;dialogHeight:340px;dialogTop:100px;dialogLeft:100px;status:no;resizable:yes;scroll:no;');
}
</script>

<style type="text/css">
    .floatL     {   float:left;}
    .border1    {   border:1px #AAAAAA solid; }
    .marginL    {   margin-left:3px;}
    .padding5   {   padding:5px; }
    .wordBreak  {   word-wrap: break-word; word-break:break-all; }
    #viewer     {   width:274px; height:98%; text-align:left;  word-wrap: break-word; word-break:break-all;overflow-y: scroll; overflow-x:hidden; margin-top: 5px; font-family: "굴림체", sans-serif; font-size: 12px; background-color: white;}
    #TableNm1   {   border:1px #AAAAAA solid; }
    #textarea   {   width: 274px; height:98%; text-align:left; overflow-y: scroll; overflow-x: hidden; padding: 0px; margin-top: 5px; border:0px; font-family: "굴림체", sans-serif; font-size: 12px; background-color: white;}
    #list       {   margin:0px; padding:0px;}
    #list li    {   margin:0px; padding:2px; list-style-position: inside; list-style-type: circle; cursor:hand; height: 20px; color: blue;}
</style>
</head>
<body>
<script type="text/javascript">
var master = [{'SHOP_CD':'S92694','SHOP_NM':'현대포스','OWNER_NM':'황의순','BIZ_TYPE_NM':'일반음식점','BIZ_KIND_NM':'한식','BIZ_NO':'127-46-15204','BIZ_SHOP_NM':'현대포스','TEL_NO':'031-000-0000','HP_NO':'','FAX_NO':'','EMAIL_ADDR':'','ADDRESS':'경기 의정부시 가능로 72 (의정부동)1','SELL_TIME':'2018-06-18 오후 06:10:31'}];     // 마스터정보 json
var codeList;                           // 코드정보 json
var editRow;                            // 현재 EditRow를 저장
function init_sheet()
{
    try
    {
        mySheet1 = fnGetObjectIdName("mySheet1");
        with(mySheet1)
        {
            //SheetWidth = document.body.clientWidth - 25;
            InitHostInfo(location.hostname, location.port, "");
            MergeSheet = msHeaderOnly;
            Editable = true;
            InitRowInfo( 1, 1, 10);
            InitColumnInfo(5, 0, 0, true);
            InitHeadRow(0,"상태|입력상태|No.|템플릿명|에디터");
            //ObjId.InitDataProperty( DataRow, DataCol, [DataType], [Width], [DataAlign], [ColMerge], [SaveName], [KeyField]
            //                      , [CalcuLogic], [DataFormat],[PointCount], [UpdateEdit], [InsertEdit], [EditLen], [FullInput]
            //                      , [SortEnable],[ToolTip], [AllCheck], [SaveStatus], [FormatFix])
            InitDataProperty(0, 0, dtHiddenStatus, 0, daCenter, false, "sStatus");
            InitDataProperty(0, 1, dtHidden      , 0, daCenter, false, "STATUS");
            InitDataProperty(0, 2, dtDataSeq     , 0, daCenter, false, "dtDataSeq");
            InitDataProperty(0, 3, dtData        , 0, daLeft  , false, "TEMPLATE_NM", false, "", dfHanKey   , 0, false, false ,   30);
            InitDataProperty(0, 4, dtHidden      , 0, daCenter, false, "PRT_FORM"   , false, "", dfHanKey   , 0, false, false , 4000);
            InitHeadMode(false, true, false, true, false, false);
            DataAutoTrim = false;
            Visible = true;
        }
    }
    catch(E)
    {
        alert("[init_sheet] " + E.name + ":" + E.message)
    }
}
function doAction(str, idx)
{
    try
    {
        fnGetObjectIdName("S_METHOD").value = str;
        sheet_obj = fnGetObjectIdName("mySheet"+idx);

        switch(str)
        {
            case "search":
                if(!jsSaveName(form1, sheet_obj)) { return false; }
                var param = FormQueryStringEnc(document.form1, sheet_obj);
                sheet_obj.ShowDebugMsg = false;
                sheet_obj.DoSearch4Post("ddd.sheetAction",param);
                fn_ResizeColWidth(sheet_obj,[0, 0, 30, 150, 0]);
            break;
            case "save":
                //alert(fnGetObjectIdName("edit").value);
                var tmp_prt_form = sheet_obj.CellValue(1, "PRT_FORM");
                if(editRow == 1 || (editRow != 1 && confirm("현재 내용을 실제출력물에 저장하시겠습니까?")))
                {
                    sheet_obj.CellValue(1, "PRT_FORM") = fnGetObjectIdName("edit").value;
                }
                var loop_cnt = sheet_obj.RowCount+1;

                var param = FormQueryStringEnc(document.form1, sheet_obj);
                if(str == 'save')
                {
                    sheet_obj.CheckAll(1) = 0;
                    if(sheet_obj.CellValue(1, "sStatus") == 'U' && "S" == 'H' && confirm("<<<<<경고>>>>>\n\n저장시 모든 매장에 적용됩니다. 진행 하시겠습니까?"))
                    {
                        sheet_obj.DoSave("ddd.sheetAction",param, -1, false);
                    }
                    else if(sheet_obj.CellValue(1, "sStatus") == 'U' && "S" == 'S')
                    {
                        sheet_obj.DoSave("ddd.sheetAction",param, -1, false);
                    }
                    else
                    {
                        sheet_obj.CellValue(1, "PRT_FORM") = tmp_prt_form;
                    }
                }
                if(sheet_obj.EtcData("retMsg") == "0000")
                {
                    //alert("저장되었습니다.")
                    sheet_obj.CheckAll(1) = 0;
                    doAction('search', idx);
                }
                break;
        }

        if(sheet_obj.EtcData("retMsg") && sheet_obj.EtcData("retMsg") != '' && sheet_obj.EtcData("retMsg") != '0000')
        {
            ErrorShow(sheet_obj.EtcData("retMsg")+'╋'+'https://asp.netusys.com/master/posprint/editor010.jsp', "popup", "");
        }
    }
    catch(E)
    {
        alert("[doAction] " + E.name + ":" + E.message)
    }
}
/////////////////////////////////////// window.onload ////////////////////////////////////
window.onload = function() { setTimeout("onloadFunctions()",0); }; function onloadFunctions()
{
    try
    {
        // CodeList 가져오는 로직 Ajax
        getPrintValue();
        init_sheet(); set_item();
        doAction('search',1);
        fnResize();
    }
    catch(E)
    {
        alert("[onload] " + E.name + ":" + E.message)
    }
}
/////////////////////////////////////// window.onresize /////////////////////////////////
window.onresize = function()
{
    fnResize();
}
/////////////////////////////////////// fnResize ///////////////////////////////////////
function fnResize()
{
    setObjHeight('mySheet1');
    fn_ResizeColWidth(mySheet1,[0, 0, 30, 150, 0]);
}
function addEvent(obj) // Code List의 코드를 Click시 발생하는 이벤트 - Edit Area에 해당 코드를 넣어준다.
{
    try
    {
        var edit = fnGetObjectIdName("edit");
        if(edit.readOnly) return false;
        edit.focus();
        var cRange = document.selection.createRange();
        cRange.text = obj.innerHTML.trim();
    }
    catch(E)
    {
        alert("[addEvent]" + E.name + " : " + E.message);
    }
    show();
}
function show() // Edit Area에 있는 코드들을 변환하여 Viewer에 영수증 내용을 보여준다.
{
    var viewer = fnGetObjectIdName("viewer");
    var content  = fnGetObjectIdName("edit").value;
    var listLen  = codeList.length;
    try
    {
        for(var i=0; i<listLen; i++)
        {
            // alert(content.replace(/[codeList[i].code]/,codeList[i].value))
            if(codeList[i].EXAMPLE_YN == "Y")
            {
                // 예제사용일경우 치환로직
                content = content.replace(new RegExp(codeList[i].PTM_CD, "g"), codeList[i].EXAMPLE);
            }
            else if(!isEmpty(codeList[i].EXAMPLE))
            {
                // 예제 비사용일시 치환로직
                content = content.replace(new RegExp(codeList[i].PTM_CD, "g"), eval("master[0]."+codeList[i].EXAMPLE));
            }
        }
        content = content.replace(/\r\n/g, "</P><P>").replace(new RegExp("<P></P>", "g"), "<P>&nbsp;</P>")

        // 정렬시작
        var matchStr = content.match(/\{:([LRC])\d{2}\}.*?\{\/:\1\}?/g); //정렬 배열로 생성
        var matchLen = 0;
        if(!isEmpty(matchStr))
        {
            matchLen = matchStr.length;
            try
            {
                for(var i=0; i<matchLen; i++)
                {
                    var arr = matchStr[i].match(/\{:([LRC])(\d{2})\}(.*?)\{\/:\1\}/);
                    if(parseInt(arr[2]) <=42)
                    {
                        var tags = arr[3].match(/<[^<|>]*>/g,"");
                        if(!isEmpty(tags))
                        {
                            var tagLen = 0;
                            var tagLen1 = 0;
                            for(var n=0; n<tags.length; n++)
                            {
                                tagLen = tagLen + tags[n].length;
                            }
                            arr[2] = parseInt(arr[2]) + tagLen - ((arr[3].length - tagLen) * 2)
                        }
                        content = content.replace(arr[0], padToStr(arr[1], arr[2], arr[3], " "));
                    }
                }
            }
            catch(E)
            {
                //alert("[for(i in matchStr)] " + E.name + ":" + E.message)
            }
        }
        // 정렬끝

        // 라인별 42자 처리
        var lineArr = ("<P>" + content + "</P>").match(/<P>.*?<\/P>?/g); //정렬 배열로 생성
        var lineLen = 0;
        var newLine = new Array();
        var nArrLen = 0;
        var str     = "";
        if(!isEmpty(lineArr))
        {
            lineLen = lineArr.length;
            for(var i=0; i<lineLen; i++)
            {
                str = lineArr[i].replace(/<P>|<\/P>?/g, "");
                if(biteLength(str) <= 42 || !isEmpty(str.match(/<img src.*?/g)) || !isEmpty(str.match(/<font.*?/g)))
                {
                    newLine[nArrLen++] = str;
                }
                else
                {
                    splitArr = splitByte(str, 42);
                    splitLen = splitArr.length;
                    for(var k=0; k<splitLen; k++)
                    {
                        newLine[nArrLen++] = splitArr[k];
                    }
                }
            }
        }
        // 라인별 42자 처리

        viewer.innerHTML = "<pre><P>" + newLine.join("</P><P>") + "</P></pre>";
    }
    catch(E)
    {
        alert("[show]" + E.message + "," + E.name + "," + E.description );
    }
}
function getPrintValue() // Ajax 통신을 이용하여 List Area에서 사용될 코드 목록을 불러온다.
{
    try
    {
        var params = "procedure=SP_CCD_PCDDT_T_S01&index=2&param=" + nullToChange(fnGetObjectIdName("PRT_CLS_CD").value, "");
        var ajax1 = new ajax.echoAjaxPage('/common/jsp/getValueByJson.jsp', params, setList, null, "POST","F");
        ajax1.send();
    }
    catch(E)
    {
        alert("[getPrintValue()] " + E.name + " : " + E.message);
    }
}
function setList(req) // Ajax response codeList 변수에 json으로 넣어준다. - @param req (getPrintValue() 의 Response)
{
    try
    {
        var jsonText = req.responseText.trim().replace(/\r\n/g, "</P><P>");
        codeList = eval( jsonText + ";");
        // ListArea에 코드리스트를 생성하는 로직 Dom방식
        createList();
    }
    catch(E)
    {
        alert("[setList()] " + E.name + ":" + E.message)
    }
}
function createList() // Code List의 목록을 생성해 준다.
{
    try
    {
        var liObj;
        var text;
        var listLen;
        var clickEvent;
        var listObj = fnGetObjectIdName("list");
        listLen = codeList.length;
        // 기존 리스트 초기화
        listObj.innerHTML = "";
        // ListArea에 코드리스트를 생성하는 로직 Dom방식
        if(0 < listLen)
        {
            for(var i = 0; i < listLen; i++)
            {
                liObj = document.createElement("li");
                text  = document.createTextNode(codeList[i].PTM_CD);
                liObj.appendChild(text);
                liObj.ondblclick = function() { addEvent(this); }
                // MouseOver, MouseOut기능 미구현 2009.01.29
                listObj.appendChild(liObj);
            }
        }
        else
        {
            liObj = document.createElement("li");
            text  = document.createTextNode("등록된 코드가 없습니다.");
            liObj.appendChild(text);
            listObj.appendChild(liObj);
        }
    }
    catch(E)
    {
        alert("[createList()] " + E.name + ":" + E.message)
    }
}
function clsChange() // 출력물 종류가 변경되었을때 발생하는 Event - 변경된 종류의 템플릿, 코드리스트 의 정보를 가져온다.
{
    try
    {
        var edit        = fnGetObjectIdName("edit");
        editRow         = null;
        edit.readOnly   = true;
        edit.value      = "";
        fnGetObjectIdName("viewer").innerHTML = "";
        doAction('search', '1');
        getPrintValue();
    }
    catch(E)
    {
        alert("[clsChange()] " + E.name + ":" + E.message);
    }
}
function editValueChange(NewRow)
{
    var edit = fnGetObjectIdName("edit");
    edit.focus();
    edit.readOnly = false;
    edit.value = fnGetObjectIdName("mySheet1").CellValue(NewRow,"PRT_FORM");
    editRow = NewRow;
    setTimeout("show()",0);
}
</script>
<script for="mySheet1" event="OnSelectCell(OldRow, OldCol, NewRow, NewCol)">
try
{
    var edit = fnGetObjectIdName("edit");
    // 기존입력의 수정이 있는데 다른것을 클릭했을때
    if(OldRow == 1 && CellValue(OldRow, "PRT_FORM") != edit.value && confirm("수정중인 출력물이 있습니다. Edit내용을 저장하시겠습니까?"))
    {
        CellValue(OldRow, "PRT_FORM") = edit.value;
        doAction('save','1');
    }
    // 기존입력이 수정없이 다른것을 클릭했을때
    else
    {
        editValueChange(NewRow);
    }
}
catch(E)
{
    alert("[OnSelectCell(OldRow, OldCol, NewRow, NewCol)] " + E.name + ":" + E.message);
}
</script>
<script for="mySheet1" event="OnDblClick(Row,Col)">
try
{
    if(Col == "3") this.focus();
}
catch(E)
{
    alert("[OnDblClick(Row,Col)] " + E.name + ":" + E.message);
}
</script>
<script>if(parent && parent.HistoryFrm && parent.HistoryFrm.MainFrmPage && parent.HistoryFrm.MainFrmPage.pgm_nm && parent.HistoryFrm.MainFrmPage.pgm_nm.value != '') {document.write("<table width='100%' border='0' cellpadding='0' cellspacing='0' background='/image/title_bg.gif'><tr height='30'><td width='10'></td><td>  <table border='0' cellpadding='0' cellspacing='0'>  <tr>  <td><img src='/image/title_icon.gif'></td>  <td width='10'></td>  <td>    <table border='0' cellpadding='0' cellspacing='0'><tr><td height='3'></td></tr><tr>    <td><font color='#FFFFFF' style='font-size:14px;'><b>"+parent.HistoryFrm.MainFrmPage.pgm_nm.value+"</b></font></td>    </tr></table>  </td>  <td width='40'></td>  <td><span id='span_mymenu'></span></td>  <td width='10'></td>  <td><img src='/image/icon01/btn_column.gif'  onclick='parent.set_menu_item();' style='cursor:hand;'></td>  </tr>  </table></td><td align='right'><font color='#FFFFFF'>"+parent.HistoryFrm.MainFrmPage.pgm_lcls_nm.value+((parent.HistoryFrm.MainFrmPage.pgm_mcls_nm.value == '') ? '' : ' &gt; '+parent.HistoryFrm.MainFrmPage.pgm_mcls_nm.value)+' &gt; '+parent.HistoryFrm.MainFrmPage.pgm_nm.value+"</font></td><td width='10'></td></tr></table>");fnSetPgmId(parent.HistoryFrm.MainFrmPage.pgm_id.value);document.getElementById('span_mymenu').innerHTML = parent.HistoryFrm.getMyMenuStr(parent.HistoryFrm.MainFrmPage.pgm_id.value);}</script>
<form name="form1">
    <!-- IBFrame 을 위한 변수 선언 (필수)-->
    <input type="hidden" name="S_CONTROLLER" value="master.posprint.editor010" />
    <input type="hidden" name="S_METHOD" value="" />
    <input type="hidden" name="S_SAVENAME" value="" />
    <table width='100%' border='0' cellpadding='0' cellspacing='0' bgcolor='e9e9e9'>
<tr height='2'><td colspan='3'></td></tr>
<tr height='27' align='absmiddle'>
<td width='10'></td><td>

    <!-- 조회조건 시작 -->
    <table border='0' cellpadding='0' cellspacing='0'>
    <tr>
    <td><img src='/image/s_icon.gif'> 종류 <script>
select_name[0] = new Array();
select_value[0] = new Array();
select_option[0] = new Array();
select_query[0] = new Array();
select_title[0] = new Array();
select_change[0] = new Array();
select_etc[0] = new Array();
</script>
<span id='divAjax_0_PRT_CLS_CD' style='display:;overflow-y:scroll;'> </span>
<script>
select_name[0][0] = "PRT_CLS_CD";
select_title[0][0] = "";
select_value[0][0] = "";
select_option[0][0] = "";
select_query[0][0] = "SP_CCD_PCDHD_T_S01♪A♪";
select_change[0][0] = "clsChange()";
select_etc[0][0] = "";
</script>
<script>
select_step2(0,0);
</script></td>
    <td width='10'></td>
    </tr>
    </table>
    <!-- 조회조건 끝 -->
    </td>
</td><td width='10'></td></tr>
<tr height='2'><td colspan='3'></td></tr>
<tr height='1' bgcolor='d6d6d6'><td colspan='3'></td></tr>
</table>

    <table width='100%' height='6' border='0' cellpadding='0' cellspacing='0'><tr><td></td></tr></table>

    <table width="100%" border="0" cellpadding="0" cellspacing="2">
    <tr valign="top" height="25">
        <td width="">
            <table width='100%' border='0' cellpadding='0' cellspacing='0' bgcolor='#e9e9e9'>
<tr height='1' bgcolor='#aaaaaa'><td colspan='6'></td></tr>
<tr height='25'>
<td width='1' bgcolor='#aaaaaa'></td>
<td width='8'></td>
<td align='left'><img src='/image/s_icon.gif'> 실제출력물 및 템플릿 리스트</td>
<td width='8'></td>
<td width='1' bgcolor='#aaaaaa'></td>
</tr>
<tr height='1' bgcolor='#aaaaaa'><td colspan='6'></td></tr>
</table>
        </td>
        <td width="200">
            <table width='100%' border='0' cellpadding='0' cellspacing='0' bgcolor='#e9e9e9'>
<tr height='1' bgcolor='#aaaaaa'><td colspan='6'></td></tr>
<tr height='25'>
<td width='1' bgcolor='#aaaaaa'></td>
<td width='8'></td>
<td align='left'><img src='/image/s_icon.gif'> Code List</td>
<td align='right'>&nbsp;</td>
<td width='8'></td>
<td width='1' bgcolor='#aaaaaa'></td>
</tr>
<tr height='1' bgcolor='#aaaaaa'><td colspan='6'></td></tr>
</table>
        </td>
        <td width="290">
            <table width='100%' border='0' cellpadding='0' cellspacing='0' bgcolor='#e9e9e9'>
<tr height='1' bgcolor='#aaaaaa'><td colspan='6'></td></tr>
<tr height='25'>
<td width='1' bgcolor='#aaaaaa'></td>
<td width='8'></td>
<td align='left'><img src='/image/s_icon.gif'> Edit</td>
<td align='right'><table border='0' cellpadding='0' cellspacing='0'><tr><td><table border='0' cellpadding='0' cellspacing='0' style='cursor:pointer;' onclick="doAction('save','1')">
<tr valign='middle'>
<td><img id='btn_l_bg' src='/image/btn_red_l_bg.gif'></td>
<td background='/image/btn_red_c_bg.gif'><img src='/image/blank.gif' width='4' height='13'><font color='#ffffff'>저장</font><img src='/image/blank.gif' width='4' height='13'></td>
<td><img id='btn_r_bg' src='/image/btn_red_r_bg.gif'></td>
</tr>
</table></td><td width='4'></td></tr></table></td>
<td width='8'></td>
<td width='1' bgcolor='#aaaaaa'></td>
</tr>
<tr height='1' bgcolor='#aaaaaa'><td colspan='6'></td></tr>
</table>
        </td>
        <td width="290">
            <table width='100%' border='0' cellpadding='0' cellspacing='0' bgcolor='#e9e9e9'>
<tr height='1' bgcolor='#aaaaaa'><td colspan='6'></td></tr>
<tr height='25'>
<td width='1' bgcolor='#aaaaaa'></td>
<td width='8'></td>
<td align='left'><img src='/image/s_icon.gif'> Viewer</td>
<td width='8'></td>
<td width='1' bgcolor='#aaaaaa'></td>
</tr>
<tr height='1' bgcolor='#aaaaaa'><td colspan='6'></td></tr>
</table>
        </td>
    </tr>
    <tr height="450" valign="top">
        <td>
            <table id='TableNm1' name='TableNm1' width='100%' height='30' border='0' cellpadding='4' cellspacing='1' bgcolor='#aaaaaa'>
<tr bgcolor='#ffffff' valign='top'><td width='100%' height='100%'><script>makeIBSheet('mySheet1');</script></td></tr>
</table>

        </td>
        <td class="border1">
            <div style="height:99%; overflow-y: auto; overflow-x: hidden;">
                <ul id="list">
                </ul>
            </div>
        </td>
        <td align="center" class="border1">
            <textarea name="edit" id="textarea" cols="42" onpropertychange="show()"></textarea>
        </td>
        <td align="center" class="border1 wordBreak">
            <div id="viewer"></div>
        </td>
    </tr>
    </table>
</form>
</body>
</html>
</body>
</html>

